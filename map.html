<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
			<title>Map Test</title>
        <style>
            #mapcanvas {
                height: 100px;
                margin: 0px;
                padding: 300px;
            }

            #map-container {
                position: relative;
            }

            #logo img {
                position: absolute;
                top: 450px;
                left: 80%;
            }
        </style>
        <script type="text/javascript" src="https://maps.google.com/maps/api/js?v=3"></script>
        <script type="text/javascript" src="http://www.google.com/jsapi"></script>
        <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
        <script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <!-- <script src="http://jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js"></script> -->
        <script src="fusiontips.js"></script>
        <script>
          var map;
          var geocoder = new google.maps.Geocoder();

          //Create info window (need only one)
          var infowindow = new google.maps.InfoWindow();

          function initialize() {
            var mapOptions = {
                zoom: 5,
                center: new google.maps.LatLng(39.50, -98.35),
                mapTypeId: google.maps.MapTypeId.TERRAIN
            };

            //Load and center map on college station
            map = new google.maps.Map(document.getElementById('mapcanvas'), mapOptions);
            var tableid = '1wKASe5otpm6hQkmxfds0nPdgAGW0gK0CZPnzOf0f';
            var googleApiKey = "AIzaSyB5k4xZvv_2oGIkHl51oBm86twTND2Z_dc";

            layer = new google.maps.FusionTablesLayer({
              query: {
                select: "col11\x3e\x3e1",
                from: tableid,
                where: "col8\x3e\x3e0 \x3d \x271\x27"
              },
              heatmap: { enabled: false },
              suppressInfoWindows: true,
              options: {
                styleId: 2,
                // templateId: 2
              },
              map: map
            });
            layer.enableMapTips({
              select: "'Zip'", // list of columns to query, typially need only one column.
              from: tableid, // fusion table name
              geometryColumn: 'Geometry', // geometry column name
              suppressMapTips: true, // optional, whether to show map tips. default false
              delay: 100, // milliseconds mouse pause before send a server query. default 300.
              tolerance: 6, // tolerance in pixel around mouse. default is 6.
              googleApiKey: googleApiKey,
              htmlTemplate: function(rows) {
                return 'Company Name: </b>' + rows[0][0];
              }
            });
            //listen to events if desired.
            // google.maps.event.addListener(layer, 'mouseover', function(fEvent) {
            google.maps.event.addListener(layer, 'mouseover', function(fEvent) {
              var row = fEvent.row;
              myHtml = '<ul>';

              // for (var x in row) {
              //   if (row.hasOwnProperty(x)) {
              //     myHtml += '<b>' + x + "</b>:" + row[x].value + "<br/>";
              //   }
              // }
              // document.getElementById('info').innerHTML = myHtml;
              $.get('https://www.googleapis.com/fusiontables/v2/query?sql=SELECT Company FROM 1wKASe5otpm6hQkmxfds0nPdgAGW0gK0CZPnzOf0f WHERE Zip = ' + row.Zip.value + '&key=AIzaSyB5k4xZvv_2oGIkHl51oBm86twTND2Z_dc', function(data, status) {

                for(var i = 0; i < data.rows.length; i++) {
                  myHtml += '<li><strong>Company</a>:</strong> <a href="https://www.google.com">' + data.rows[i][0] + '</a>';
                }
                myHtml += '</ul>'
                document.getElementById('info').innerHTML = myHtml;
              });
            });
            // google.maps.event.addListener(map,'click',function(event) {
            //   console.log(event);
            //   infowindow.setContent(event.latLng.lat()+","+event.latLng.lng());
            //   infowindow.open(map,this);
            //   infowindow.open(map,this);
            // });

            // google.maps.event.addListener(layer, 'mouseout', function(fevt) {
            //   document.getElementById('info').innerHTML = '';
            // });
          }

          function codeAddress() {
          	var address = document.getElementById("address").value;
            $.get('https://www.googleapis.com/fusiontables/v2/query?sql=SELECT Zip FROM 1wKASe5otpm6hQkmxfds0nPdgAGW0gK0CZPnzOf0f WHERE Zip = ' + address + '&key=AIzaSyB5k4xZvv_2oGIkHl51oBm86twTND2Z_dc', function(data, status) {
              // console.log(data);
              if(data.hasOwnProperty('rows')) {
                //Placeholder
              } else {
                alert('Not available in your area!');
              }
            });

          	geocoder.geocode( { 'address': address}, function(results, status) {
          		if (status == google.maps.GeocoderStatus.OK) {
          			map.setCenter(results[0].geometry.location);
          		if (results[0].geometry.viewport)
          			map.fitBounds(results[0].geometry.viewport);
          		} else {
          		alert("Geocode was not successful for the following reason: " + status);
          		}
          	});
          }

          google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>
    <body>
      <div id="map-container">
        <div id="mapcanvas"></div>
        <div id="logo">
          <a href="https://www.energystar.gov"><img src="es.png"></a>
        </div>
      </div>
      <div id="search">
        <input id="address" type="text" onkeydown="if (event.keyCode == 13) {document.getElementById('geocode').click()}"></input>
        <input id="geocode" type="button" onclick="codeAddress();" value="Search"></input>
      </div>
      <div id="info"></div>
    </body>
</html>
