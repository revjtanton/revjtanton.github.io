<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<head>
 	    <style>
			#map_canvas { width: 1200px; height: 1200px; }
        </style>

		<script type="text/javascript" src="http://www.google.com/jsapi"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
		<script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>
    <script type="text/javascript">
			google.load('visualization', '1', {'packages':['corechart', 'table', 'geomap']});
			var map;
			var labels = [];
			var layer;
			//var tableid =  '2996349';
			var tableid = '1FhXAOjayEwmB9esdq_qJRyoFKAHJKkPeWA_7ElF_';

			function initialize() {
				geocoder = new google.maps.Geocoder();
				map = new google.maps.Map(document.getElementById('map_canvas'), {
				center: new google.maps.LatLng(39.50, -98.35),
				zoom: 5,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			  });

			  //layer = new google.maps.FusionTablesLayer(tableid);
				layer = new google.maps.FusionTablesLayer({
					query: {
						select: 'geometry',
						from: tableid,
						where: 'show = 1'
					},
					map: map
				});
				layer.setOptions({
					query: {
						select: 'geometry',
						from: tableid,
						where: '\'show\' = 1'
					}
				});

			  //layer.setQuery("SELECT 'geometry' FROM " + tableid);
			  //layer.setMap(map);

			  google.maps.event.addListener(map, "bounds_changed", function() {
					displayZips();
			  });
			  google.maps.event.addListener(map, "zoom_changed", function() {
			  console.log(map.getZoom());
				if (map.getZoom() < 11) {
				  for (var i=0; i<labels.length; i++) {
					labels[i].setMap(null);
				  }
				}
			  });
			}

			function filterData() {
				alert('test');
			  var filter = [];


		    if (!layer.getMap()) {
		      layer.setMap(map);
		    }
					    layer.setOptions({
					      query: {
					        select: 'geometry',
					        from: tableid,
					        where: '\'show\' = 1'
					      }
					    });
			}

			function codeAddress() {
				alert('fail');
				var address = document.getElementById("address").value;
				geocoder.geocode( { 'address': address}, function(results, status) {
				  if (status == google.maps.GeocoderStatus.OK) {
					map.setCenter(results[0].geometry.location);
					var marker = new google.maps.Marker({
						map: map,
						position: results[0].geometry.location
					});
					if (results[0].geometry.viewport)
					  map.fitBounds(results[0].geometry.viewport);
				  } else {
					alert("Geocode was not successful for the following reason: " + status);
				  }
				});
			  }

			function displayZips() {
			  //set the query using the current bounds
			  var queryStr = "SELECT geometry, ZIPCODE, latitude, longitude FROM "+ tableid + " WHERE ST_INTERSECTS(geometry, RECTANGLE(LATLNG"+map.getBounds().getSouthWest()+",LATLNG"+map.getBounds().getNorthEast()+"))";
			  var queryText = encodeURIComponent(queryStr);
			  var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);
			  // alert(queryStr);

			  //set the callback function
			  query.send(displayZipText);

			}

			var infowindow = new google.maps.InfoWindow();

			function displayZipText(response) {
			if (!response) {
			  alert('no response');
			  return;
			}
			if (response.isError()) {
			  alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
			  return;
			}
			  if (map.getZoom() < 11) return;
			  FTresponse = response;
			  //for more information on the response object, see the documentation
			  //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
			  numRows = response.getDataTable().getNumberOfRows();
			  numCols = response.getDataTable().getNumberOfColumns();
			  for(i = 0; i < numRows; i++) {
				  var zip = response.getDataTable().getValue(i, 1);
				  var zipStr = zip.toString()
				  while (zipStr.length < 5) { zipStr = '0' + zipStr; }
				  var point = new google.maps.LatLng(
					  parseFloat(response.getDataTable().getValue(i, 2)),
					  parseFloat(response.getDataTable().getValue(i, 3)));
				  // bounds.extend(point);
				  labels.push(new InfoBox({
				 content: zipStr
				,boxStyle: {
				   border: "1px solid black"
				  ,textAlign: "center"
				  ,fontSize: "8pt"
				  ,width: "50px"
				 }
				,disableAutoPan: true
				,pixelOffset: new google.maps.Size(-25, 0)
				,position: point
				,closeBoxURL: ""
				,isHidden: false
				,enableEventPropagation: true
				  }));
				  labels[labels.length-1].open(map);
			  }
			  // zoom to the bounds
			  // map.fitBounds(bounds);
			}
    </script>
	</head>
	<body onload="initialize();">
		<form>
			<span class="style51"><span class="style49">Show:</span>
			<input id="address" type="text"></input>
			<input id="geocode" type="button" onclick="codeAddress();" value="Geocode"></input>
		</form>
		<div id="map_canvas"></div>
	</body>
</html>
