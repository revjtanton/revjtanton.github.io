<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
			<title>Map Test</title>
        <style>
            #mapcanvas {
                height: 300px;
                margin: 0px;
                padding: 300px;
            }
        </style>
        <script type="text/javascript" src="http://www.google.com/jsapi"></script>
        <script type="text/javascript" src="https://maps.google.com/maps/api/js?v=3"></script>
        <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
        <script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="http://jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js"></script>
        <script>
            var map;
            var oms;
          	var geocoder = new google.maps.Geocoder();

            //Create info window (need only one)
            var infowindow = new google.maps.InfoWindow();

            function initialize() {

                var mapOptions = {
                    zoom: 5,
                    center: new google.maps.LatLng(39.50, -98.35)
                };

                //Load and center map on college station
                map = new google.maps.Map(document.getElementById('mapcanvas'), mapOptions);

                    layer = new google.maps.FusionTablesLayer({
                      map: map,
                      heatmap: { enabled: false },
                      query: {
                        select: "col11\x3e\x3e1",
                        from: "1FhXAOjayEwmB9esdq_qJRyoFKAHJKkPeWA_7ElF_",
                        where: "col8\x3e\x3e0 \x3d \x271\x27"
                      },
                			suppressInfoWindows: true,
                      options: {
                        styleId: 2,
                        // templateId: 2
                      }
                    });

                oms = new OverlappingMarkerSpiderfier(map);

                // listeners need to be registered only once
                oms.addListener('click', function(marker, event) {
                    infowindow.setContent(marker.description);
                    infowindow.open(map, marker);
                });

                oms.addListener('spiderfy', function(markers) {
                    for(var i = 0; i < markers.length; i++) {
                        // markers[i].setIcon(iconWithColor(spiderfiedColor));
                        markers[i].setShadow(null);
                    }
                    infowindow.close();
                });

                oms.addListener('unspiderfy', function(markers) {
                    for(var i = 0; i < markers.length; i++) {
                        // markers[i].setIcon(iconWithColor(usualColor));
                        // markers[i].setShadow(shadow);
                    }
                });

                function handleItem(items) {

                    //Info window content
                    var contentString = '<div id=content">'+
                    'Utility Companty'+
                    '</div>'+
                    '<p id = "firstHeading" class="firstHeading"><a href="' + items.url + '" target="_blank">' + items.name + '</a></p>' +
                    '</div>'

                    var img = 'http://www.google.com/mapfiles/marker.png';
                    var myLatLng = new google.maps.LatLng(items.lat, items.long);
                    var marker = new google.maps.Marker({
                        position: myLatLng,
                        map: map,
                        icon: img
                    });

                    // to be possible in "click" show specific content
                    marker.description = contentString;

                    oms.addMarker(marker);
                }

                $.get('https://www.googleapis.com/fusiontables/v2/query?sql=SELECT * FROM 19u_v6otm1gDJ6uQe7off1qYTdD4tqnVO3de8r03t&key=AIzaSyB5k4xZvv_2oGIkHl51oBm86twTND2Z_dc', function(data, status) {
                  for(var i = 0; i < data.rows.length; i++) {
                    if(data.rows[i][4] == 1) {
                      var item = {
                          lat: data.rows[i][1],
                          long: data.rows[i][2],
                          name: data.rows[i][3],
                          url: data.rows[i][5]
                      };
                      handleItem(item);
                    }
                  }
                });
            }

          	function codeAddress() {
          		var address = document.getElementById("address").value;
          		geocoder.geocode( { 'address': address}, function(results, status) {
          			if (status == google.maps.GeocoderStatus.OK) {
          				map.setCenter(results[0].geometry.location);
          			if (results[0].geometry.viewport)
          				map.fitBounds(results[0].geometry.viewport);
          			} else {
          			alert("Geocode was not successful for the following reason: " + status);
          			}
          		});
          	}

            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>
    <body>

    <form>
      <input id="address" type="text"></input>
      <input id="geocode" type="button" onclick="codeAddress();" value="Search"></input>
    </form>
        <div id="mapcanvas"></div>
    </body>
</html>
